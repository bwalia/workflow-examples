global
    daemon
    maxconn 4096
    log stdout format raw local0

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option httplog
    option dontlognull
    option redispatch
    retries 3
    log global

# ============================================
# Frontend for Nginx App Load Balancer (port 9090)
# ============================================
frontend nginx_app_frontend
    bind *:9090
    default_backend nginx_app_backend
    option forwardfor

backend nginx_app_backend
    balance roundrobin
    option httpchk GET /
    http-check expect status 200,301,302,404
    # Add headers to identify which NetScaler served the request
    http-response set-header X-Served-By %s
    http-response set-header X-NetScaler-Node %s
    http-response set-header X-HA-Status "active"
    # Primary NetScaler - higher weight, preferred
    server netscaler-primary 172.28.0.10:9090 check inter 5s fall 3 rise 2 weight 100
    # Secondary NetScaler - backup, takes over if primary fails
    server netscaler-secondary 172.28.0.15:9090 check inter 5s fall 3 rise 2 weight 100 backup

# ============================================
# Frontend for API Service Load Balancer (port 9091)
# ============================================
frontend api_service_frontend
    bind *:9091
    default_backend api_service_backend
    option forwardfor

backend api_service_backend
    balance roundrobin
    option httpchk GET /
    http-check expect status 200,301,302,404
    # Add headers to identify which NetScaler served the request
    http-response set-header X-Served-By %s
    http-response set-header X-NetScaler-Node %s
    http-response set-header X-HA-Status "active"
    server netscaler-primary 172.28.0.10:9091 check inter 5s fall 3 rise 2 weight 100
    server netscaler-secondary 172.28.0.15:9091 check inter 5s fall 3 rise 2 weight 100 backup

# ============================================
# Frontend for Web App Load Balancer (port 9092)
# ============================================
frontend web_app_frontend
    bind *:9092
    default_backend web_app_backend
    option forwardfor

backend web_app_backend
    balance roundrobin
    option httpchk GET /
    http-check expect status 200,301,302,404
    # Add headers to identify which NetScaler served the request
    http-response set-header X-Served-By %s
    http-response set-header X-NetScaler-Node %s
    http-response set-header X-HA-Status "active"
    server netscaler-primary 172.28.0.10:9092 check inter 5s fall 3 rise 2 weight 100
    server netscaler-secondary 172.28.0.15:9092 check inter 5s fall 3 rise 2 weight 100 backup

# ============================================
# Stats page for monitoring HA status
# ============================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats show-node
    stats auth admin:admin
