events {
    worker_connections 1024;
}

http {
    # NetScaler CPX load balancer VIP on port 9090
    # Uses Docker internal network with container hostname
    upstream netscaler_backend {
        server netscaler-cpx:9090;
        keepalive 32;
    }

    # Upstream for App 1 - direct to container via Docker network (using container hostname)
    upstream app1_backend {
        server nginx-app1:80;
        keepalive 32;
    }

    # Upstream for App 2 - direct to container via Docker network (using container hostname)
    upstream app2_backend {
        server nginx-app2:80;
        keepalive 32;
    }

    # Upstream for App 3 - direct to container via Docker network (using container hostname)
    upstream app3_backend {
        server nginx-app3:80;
        keepalive 32;
    }

    # App 1 - netscaler-app-1.workstation.co.uk
    # Route: External -> nginx-router:80 -> nginx-app1 via Docker internal network (172.28.0.11:80)
    server {
        listen 80;
        server_name netscaler-app-1.workstation.co.uk;

        location / {
            proxy_pass http://app1_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }

    # App 2 - netscaler-app-2.workstation.co.uk
    # Route: External -> nginx-router:80 -> nginx-app2 via Docker internal network (172.28.0.12:80)
    server {
        listen 80;
        server_name netscaler-app-2.workstation.co.uk;

        location / {
            proxy_pass http://app2_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }

    # App 3 - netscaler-app-3.workstation.co.uk
    # Route: External -> nginx-router:80 -> nginx-app3 via Docker internal network (172.28.0.13:80)
    server {
        listen 80;
        server_name netscaler-app-3.workstation.co.uk;

        location / {
            proxy_pass http://app3_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }

    # Default - route through NetScaler load balancer
    server {
        listen 80 default_server;
        server_name _;

        location / {
            proxy_pass http://netscaler_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }
}
