version: '3.8'

networks:
  netscaler-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

services:
  netscaler-cpx:
    image: quay.io/citrix/citrix-k8s-cpx-ingress:13.0-64.35
    container_name: netscaler-cpx
    hostname: netscaler-cpx
    privileged: true
    ports:
      - "9080:80"       # HTTP VIP
      - "9443:443"      # HTTPS VIP
      - "9090:9090"     # Custom HTTP port for nginx app load balancer
      - "9091:9091"     # Custom HTTP port for API service load balancer
      - "9092:9092"     # Custom HTTP port for web app load balancer
      - "9022:22"       # SSH
      - "8181:9080"     # Management HTTP
      - "8443:9443"     # Management HTTPS
    environment:
      - EULA=yes
      - NS_CPX_LICENSE_MODE=CPX_EXPRESS
    volumes:
      - netscaler-logs:/var/log
      - netscaler-config:/var/netscaler
    # Use tmpfs for /var/nstmp to ensure proper permissions
    tmpfs:
      - /var/nstmp:rw,exec,nosuid,size=512m
    restart: unless-stopped
    mem_limit: 2g
    cpus: 1.0
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx-backend:
    image: nginx:alpine
    container_name: nginx-backend
    hostname: nginx-backend
    ports:
      - "8081:80"
    volumes:
      - ./nginx-backend/index.html:/usr/share/nginx/html/index.html:ro
      - ./nginx-backend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.20
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx-app1:
    image: nginx:alpine
    container_name: nginx-app1
    hostname: nginx-app1
    ports:
      - "8082:80"
    volumes:
      - ./nginx-app1/index.html:/usr/share/nginx/html/index.html:ro
      - ./nginx-app1/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.11
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx-app2:
    image: nginx:alpine
    container_name: nginx-app2
    hostname: nginx-app2
    ports:
      - "8083:80"
    volumes:
      - ./nginx-app2/index.html:/usr/share/nginx/html/index.html:ro
      - ./nginx-app2/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.12
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx-app3:
    image: nginx:alpine
    container_name: nginx-app3
    hostname: nginx-app3
    ports:
      - "8084:80"
    volumes:
      - ./nginx-app3/index.html:/usr/share/nginx/html/index.html:ro
      - ./nginx-app3/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.13
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # API Service - 3 instances load balanced
  # ============================================
  api-app1:
    image: nginx:alpine
    container_name: api-app1
    hostname: api-app1
    ports:
      - "8091:80"
    volumes:
      - ./api-app1/index.html:/usr/share/nginx/html/index.html:ro
      - ./api-app1/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.21
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  api-app2:
    image: nginx:alpine
    container_name: api-app2
    hostname: api-app2
    ports:
      - "8092:80"
    volumes:
      - ./api-app2/index.html:/usr/share/nginx/html/index.html:ro
      - ./api-app2/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.22
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  api-app3:
    image: nginx:alpine
    container_name: api-app3
    hostname: api-app3
    ports:
      - "8093:80"
    volumes:
      - ./api-app3/index.html:/usr/share/nginx/html/index.html:ro
      - ./api-app3/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.23
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Web App Service - 3 instances load balanced
  # ============================================
  web-app1:
    image: nginx:alpine
    container_name: web-app1
    hostname: web-app1
    ports:
      - "8094:80"
    volumes:
      - ./web-app1/index.html:/usr/share/nginx/html/index.html:ro
      - ./web-app1/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.31
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  web-app2:
    image: nginx:alpine
    container_name: web-app2
    hostname: web-app2
    ports:
      - "8095:80"
    volumes:
      - ./web-app2/index.html:/usr/share/nginx/html/index.html:ro
      - ./web-app2/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.32
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  web-app3:
    image: nginx:alpine
    container_name: web-app3
    hostname: web-app3
    ports:
      - "8096:80"
    volumes:
      - ./web-app3/index.html:/usr/share/nginx/html/index.html:ro
      - ./web-app3/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.33
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  netscaler-exporter:
    image: quay.io/citrix/citrix-observability-exporter:latest
    container_name: netscaler-exporter
    hostname: netscaler-exporter
    ports:
      - "5563:5563"
    environment:
      - NS_IP=host.docker.internal
      - NS_PORT=8181
      - NS_USER=nsroot
      - NS_PASS=1e99e7f1ae1e42f9baa57530535d99fd
      - LOG_LEVEL=INFO
      - EXPORTER_TYPE=Prometheus
      - PROMETHEUS_PORT=5563
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      netscaler-network:
        ipv4_address: 172.28.0.30
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5563/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  netscaler-logs:
  netscaler-config:

